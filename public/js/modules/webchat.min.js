define(["AX","jquery","WebchatJSSDK","MobileDetect"],function(t,e,i,n){"use strict";var a=t.Util.log,s=t.Base.extend({defaults:{debug:!1,jsSDKAPI:"/api/wechat/JSSdkConfig",jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],defaultTitle:"Microsoft Azure",defaultDescription:"Microsoft Azure",defaultIconURL:"",defaultType:"link",$content:e(".content"),thumbnailClassName:"webchat-thumbnail"},init:function(t){this.isWebchatBrowser()&&(this._config=e.extend({},this.defaults,t),this.getConfig())},getConfig:function(){var t=this;e.ajax({url:t.get("jsSDKAPI"),dataType:"json"}).done(function(e){t.set("APIData",e),t.validatePermission()}).fail(function(t,e){a("Webchat","Get Webchat API failed."+e)})},validatePermission:function(){var t=this,e=this.get("APIData");a(e),i.config({debug:t.get("debug"),appId:e.AppId,timestamp:e.TimeStamp,nonceStr:e.NonceString,signature:e.Signature,jsApiList:t.get("jsApiList")}),i.ready(function(){t.ready(),a("Webchat","Webchat Ready!")})},checkJSAPI:function(){},isWebchatBrowser:function(){var t=new n(window.navigator.userAgent);return!!t.version("MicroMessenger")},ready:function(){this.bind()},getThumbnail:function(){var t=this,i=e("."+t.get("thumbnailClassName"));if(i.length>0)return i.attr("href");var n=null;if(e.each(this.get("$content").find("img"),function(){return e(this).width()>300&&e(this).height()>300?(n=e(this),!1):void 0}),n){var a=n.attr("src");if(/^\/\/\S+/g.test(a))return window.location.protocol+a}return window.location.origin+this.get("defaultIconURL")},getTitle:function(){var t=e("title").html();return""!==t?t:this.get("defaultTitle")},getDescription:function(){var t=e('meta[name="description"]').attr("content");return""!==t?t:this.get("defaultDescription")},bind:function(){var t=this;i.onMenuShareTimeline({title:t.getTitle(),link:window.location.href,imgUrl:t.getThumbnail(),success:function(){a("Webchat","Share successful.")},cancel:function(){}}),i.onMenuShareAppMessage({title:t.getTitle(),desc:t.getDescription(),link:window.location.href,imgUrl:t.getThumbnail(),type:t.get("defaultType"),dataUrl:"",success:function(){a("Webchat","Share successful.")},cancel:function(){}})}});return s});